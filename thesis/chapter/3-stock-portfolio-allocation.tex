\documentclass[../xlapes02]{subfiles}
\begin{document}
    \chapter{Stock Portfolio Allocation}\label{sec:stock-portfolio-allocation}
    The goal of this chapter is to describe the stock portfolio allocation problem in \cref{sec:portfolio-management-task}, and the environment, defined in \cref{sec:environment} that we have created to solve it. We will also describe the datasets that we have used to train and test our agent, in \cref{sec:data-engineering}.


    \section{Portfolio Management Task}\label{sec:portfolio-management-task}
    Let's consider a portfolio consisting of $N$ risky assets traded over $T$ time slots. The objective of portfolio management is to maximize profits while minimizing risks. We denote the closing prices of all assets at time slot $t$ as $\mathbf{p}(t) \in \mathbb{R}^N$. The price relative vector $\mathbf{y}(t) \in \mathbb{R}^N$ is defined as the element-wise division of $\mathbf{p}(t)$ by $\mathbf{p}(t-1)$, representing the relative change in prices from one-time slot to the next~\cite{finrl-portfolio-allocation-2020}:

    \begin{equation}
        \mathbf{y}(t)=\left[\frac{\mathbf{p_1}(t)}{\mathbf{p_1}(t-1)}, \frac{\mathbf{p_2}(t)}{\mathbf{p_2}(t-1)}, \cdots, \frac{\mathbf{p_N}(t)}{\mathbf{p_N}(t-1)}\right]\text{ , for }t=1,\ldots,T
    \end{equation}

    where $\mathbf{p}(0) \in \mathbb{R}^N$ is the vector of opening prices at $t = 1$. Let $\mathbf{w}(t) \in \mathbb{R}^N$ denote the portfolio weights for each of $N$ risky assets, which are updated at the beginning of time slot $t$. Let $v(t) \in \mathbb{R}$ denote the portfolio value at the beginning of time slot $t+1$, ignoring transaction costs. The relative portfolio value is defined as the ratio between the portfolio value at the end of time slot $t$ and that at the beginning of time slot $t$~\cite{finrl-portfolio-allocation-2020}:

    \begin{equation}
        v(t)=v(t-1)(\mathbf{w}(t)^\top\mathbf{y}(t))\text{ , for }t=1,\ldots,T
    \end{equation}

    where $v(0)$ is the initial capital, $v(t-1)$ is the portfolio value at the end of time slot $t-1$ according to the previous realocation (using $v(t-2)$ and weights $w(t-1)$), and $\mathbf{w}(t)^\top\mathbf{y}(t)$ is the portfolio change according to the new weights. The rate of portfolio return is defined as the ratio between the portfolio value at the end of time slot $t-1$ and that at the end of time slot $t$~\cite{finrl-portfolio-allocation-2020}:
    \begin{equation}
        \rho(t)=\frac{v(t)}{v(t-1)}-1=\mathbf{w}(t)^\top\mathbf{y}(t)-1\text{ , for }t=1,\ldots,T
    \end{equation}

    The risk of a portfolio is defined as the variance of the rate of portfolio return $\varrho(t)$:
    \begin{equation}
        \text{Risk}(t)=\text{Var}(\rho(t))=\text{Var}(\mathbf{w}(t)^\top \mathbf{y}(t) - 1)
    \end{equation}

    If there is no transaction cost, the final portfolio value is:
    \begin{equation}
        v(T) = v(0) \prod_{t=2}^T\mathbf{w}(t)^\top \mathbf{y}(t)
    \end{equation}

    The portfolio management task~\cite{enwiki:1043516653} involves finding an optimal portfolio weight vector $\mathbf{w}^*(t) \in \mathbb{R}^N$ at time slot $t$ such that $\mathbf{w}^*(t)$ is the argmax of the objective function:
    \begin{equation}
        w^*(t)=\argmax_{w(t)}\mathbf{w}^\top(t)\mathbf{y}(t)-\lambda\mathbf{w}^\top(t)\text{Cov}(\mathbf{y}(t))\mathbf{w}(t),
    \end{equation}
    where $\lambda > 0$ is the risk aversion parameter, $\mathbf{y}(t) \in \mathbb{R}^N$ is the estimated price relative vector at time slot $t$ based on a regression model using predictive financial features and the Capital Asset Pricing Model (CAPM)~\cite{fama-2004}, and $\text{Cov}(\mathbf{y}(t))$ is the estimated sample covariance matrix at time slot $t$ using historical data. The objective is to maximize the portfolio's expected return while considering the risk (variance) of the portfolio, with the constraint that the portfolio weights sum up to 1 and are bounded between 0 and 1 for each asset~\cite{finrl-portfolio-allocation-2020}:
    \begin{equation}
        \sum_{i=1}^{N}w_i(t)=1,\quad w_i(t)\in[0,1],\quad t=1,\ldots,T
    \end{equation}


    \section{Environment}\label{sec:environment}
    In this section, we describe our approach to environment modeling by first defining the action space \cref{subsec:action-space}, state and observation space~\cref{subsec:state-space}, and reward function~\cref{subsec:reward-function}. The theory behind this was already described in~\cref{ch:reinforcement-learning}, so now we will focus on the practical implementation of the environment.

    \subsection{State and Observation Space}\label{subsec:state-space}
    In portfolio Management, \emph{State space} and \emph{Observation space} is the same. It is defined as the matrix $N\times F$, where $N$ is the number of risky assets (companies) and $F$ is the number of features. The features are the financial fundamental or technical indicators. The state space is the matrix of the elements of the risky assets at time $t$. The observation space is the matrix of the features of the risky assets at time $t+1$, more about Data Engineering in~\cref{sec:data-engineering}.

    \subsection{Action Space}\label{subsec:action-space}
    The action space is the vector of the weights of the $N$ risky assets and one weight is preserved for cash. The weights are bounded between 0 and 1 when the weights (action) are provided by an agent, then for their normalization is used softmax function. The softmax function is defined as:
    \begin{equation}
        \sigma(\mathbf{z})_i=\frac{e^{z_i}}{\sum_{j=1}^{N}e^{z_j}}
    \end{equation}
    which is a generalization of the logistic function to multiple dimensions. The softmax function converts a vector of arbitrary real values to a vector of real values in the range (0, 1) that add up to 1. This is useful for representing a probability distribution over $N$ different possible outcomes.

    \subsection{Reward Function}\label{subsec:reward-function}
    The reward function is defined as the rate of portfolio return $\rho(t)$:
    \begin{equation}
        \begin{split}
            \rho(t)&=\frac{v(t)}{v(t-1)}-1\\
            &=\mathbf{w}(t)_{1:N-1}^\top\mathbf{y}(t)-1\\
        \end{split}
    \end{equation}
    where $\mathbf{w}(t)_{1:N-1}^\top$ represents the new portfolio weights excluding the weight for cash, and $\mathbf{y}(t)$ denotes the estimated price relative vector at time slot $t$. The weight for cash is not considered in the reward function as it has no impact on the portfolio return.


    \chapter{Implementation}\label{ch:implementation}


    \section{Data Engineering}\label{sec:data-engineering}
    Data engineering is critical in AI to ensure data quality, preparation, integration, scalability, governance, and performance optimization. It involves cleaning, organizing, and transforming data for accurate model training, handling large volumes of data, and adhering to regulations. High-quality data and effective data engineering processes are crucial for developing reliable and scalable AI models. In this section, we describe our approach to data engineering used for Portfolio Management by first defining the data collection~\cref{subsec:data-collection}, dataset preprocessing~\cref{subsec:dataset-preprocessing}, and dataset splitting~\cref{subsec:dataset-splitting}.

    \subsection{Data Collection}\label{subsec:data-collection}
    Raw data was gathered from these sources:
    \begin{itemize}
        \item Yahoo Finance: https://finance.yahoo.com/
        \item Financial Modeling Prep: https://financialmodelingprep.com/
    \end{itemize}
    these sources provide financial data for 60000+ tickers, with a history of over 30 years.

    We focus on tickers (companies) from Dow Jones Industrial Average (DJIA), which includes 30 companies. More about which companies are included in DJIA, you can see~\cite{enwiki:1141766585}.

    \subsection{Data Preprocessing}\label{subsec:dataset-preprocessing}
    In this section, we describe our approach to dataset preprocessing by first defining the data cleaning~\cref{subsubsec:data-cleaning}, feature engineering~\cref{subsubsec:feature-engineering}.

    \subsubsection{Data Cleaning}\label{subsubsec:data-cleaning}
    In our datasets, we use the following companies' data: prices, financial statements, and technical indicators. The prices are used for calculating the returns, the financial statements are used for calculating the financial ratios, and the technical indicators are used for calculating the technical ratios. The financial and technical ratios are used for feature engineering. The data cleaning is done by removing the rows with missing values. The missing values are replaced with the mean of the column. If on any date the data is missing completely, then all rows until that next date are removed for other companies as well. This can mostly happen for companies that are not listed on the stock exchange for any time period. The data cleaning is done for all the datasets.

    \subsection{Feature Engineering}\label{subsubsec:feature-engineering}
    In this subsection, we describe our approach to feature engineering which we divide into three parts: fundamental analysis, described in~\cref{subsubsec:fundamental-analysis}, technical analysis, described in~\cref{subsubsec:technical-analysis}, and combined fundamental and technical analysis is described in~\cref{subsubsec:combined-fundamental-and-technical-analysis}.

    \subsubsection{Fundamental Analysis}\label{subsubsec:fundamental-analysis}
    Fundamental data refers to the basic and essential information about a company or an asset that is used to analyze its financial health, performance, and valuation. It includes data related to a company's financial statements, business operations, management team, industry, and economic environment. Fundamental data is commonly used by investors, analysts, and financial professionals to make investment decisions and assess the intrinsic value of an asset. For fundamental analysis, we use the following Income Statement, Balance Sheet, and Cash Flow of each company. For our first dataset, we use the following financial ratios: Net Profit Margin. Return on Assets (ROA), Return on Equity (ROE), Current Ratio, Cash Ratio, Inventory Turnover, Receivables Turnover, Payables Turnover, Debt Ratio, Debt to Equity Ratio, A Price to Earnings Ratio (PE Ratio), Price to Book Ratio (PB Ratio), and Dividend Yield. Now we describe each of these ratios.

    \paragraph{Net Income}\label{par:net-income}
    Net income is the amount of money a company makes after subtracting all expenses and taxes. It is also known as the bottom line because it is found on the last line of a company's income statement. The Net Income is calculated as:
    \begin{equation}
        \begin{split}
            Net\ Income&=R-COGS-E-I-T\\
        \end{split}
    \end{equation}
    where $R$ is the revenue, $COGS$ is the cost of goods sold, $E$ is the expenses, $I$ is the interest, and $T$ is the taxes.

    \paragraph{Operating Profit Margin}\label{par:operating-profit-margin}
    The Operating Margin represents how efficiently a company is able to generate profit through its core operations. It is expressed on a per-sale basis after accounting for variable costs but before paying any interest or taxes (EBIT). Higher margins are considered better than lower margins and can be compared between similar competitors but not across different industries. To calculate the operating margin, divide operating income (earnings) by sales (revenues)~\cite{investopedia-operating-margin}:
    \begin{equation}
        Operating\ Margin=\frac{Operating\ Income}{Sales}
    \end{equation}
    where $Operating\ Income$ refers to the adjusted revenue of a company after all expenses of operation and depreciation are subtracted. Expenses of operation or operating expenses are simply the costs incurred in order to keep the business running~\cite{investopedia-operating-income}. $Sales$ may be defined as money paid by customers. Sales are a company's core revenue for a given period~\cite{investopedia-operating-margin}.

    \paragraph{Net Profit Margin}\label{par:net-profit-margin}
    The Net Profit Margin is a profitability ratio that measures a company's ability to generate income after all expenses and taxes have been paid. It is calculated by dividing a company's net income by its total revenue. The net profit margin is a measure of how much of each dollar of revenue is left over after all expenses and taxes have been paid. It is a useful metric for comparing the profitability of different companies in the same industry. The higher the net profit margin, the more profitable a company is. The net profit margin is calculated as follows~\cite{investopedia-net-profit-margin}.:
    \begin{equation}
        \begin{split}
            Net\ Profit\ Margin&=\frac{Net\ Income}{Revenue}\\
        \end{split}
    \end{equation}

    \paragraph{Return On Assets}\label{par:return-on-assets}
    Return on assets (ROA) is a measure of profitability that calculates how much profit a company makes with the money it has invested. It is calculated by dividing a company's net income by its total assets. The higher the ROA, the more profitable a company is. The ROA is calculated as follows~\cite{investopedia-return-on-assets}:
    \begin{equation}
        \begin{split}
            Return\ On\ Assets&=\frac{Net\ Income}{Total\ Assets}\\
        \end{split}
    \end{equation}

    \paragraph{Return On Equity}\label{par:return-on-equity}
    Return on equity (ROE) is a measure of profitability that calculates how much profit a company makes with the money shareholders have invested. It is calculated by dividing a company's net income by its shareholders' equity. The higher the ROE, the more profitable a company is. The ROE is calculated as follows~\cite{investopedia-return-on-equity}:
    \begin{equation}
        \begin{split}
            Return\ On\ Equity&=\frac{Net\ Income}{Average Shareholders'\ Equity}\\
        \end{split}
    \end{equation}

    \paragraph{Current Ratio}\label{par:current-ratio}
    The current ratio is a liquidity ratio that measures a company's ability to pay short-term and long-term obligations. It is calculated by dividing a company's current assets by its current liabilities. The higher the current ratio, the more capable a company is of paying its short-term and long-term obligations. The current ratio is calculated as follows~\cite{investopedia-current-ratio}:
    \begin{equation}
        \begin{split}
            Current\ Ratio&=\frac{Current\ Ratio}{Debt+Other\ Payables}\\
        \end{split}
    \end{equation}
    where $Current\ Ratio$ is $Cash\&Equivalent+Short\ Term\ Investments+Account\ Receivable+Inventory$. If the $Current Ratio < 1$ that is a sign of financial distress, and the company could be unable to pay its short-term and long-term obligations. On the other hand, if the $Current Ratio$ is too high, it could be a sign that the company is not using its assets efficiently.

    \paragraph{Quick Ratio}\label{par:quick-ratio}
    The quick ratio is a liquidity ratio that measures a company's ability to pay short-term obligations. It is calculated by dividing a company's quick assets by its current liabilities. The higher the quick ratio, the more capable a company is of paying its short-term obligations. The quick ratio is calculated as follows~\cite{investopedia-quick-ratio}:
    \begin{equation}
        \begin{split}
            Quick\ Ratio&=\frac{Cash\&Equivalent+Short\ Term\ Investments+Account\ Receivable}{Current\ Liabilities}\\
        \end{split}
    \end{equation}
    If the company would have a $Quick Ratio < 1$, it would be a sign of financial distress, and the company would be unable to pay its short-term obligations.

    \paragraph{Cash Ratio}\label{par:cash-ratio}
    The cash ratio is a liquidity ratio that measures a company's ability to pay short-term obligations. It is calculated by dividing a company's cash and cash equivalents by its current liabilities. The higher the cash ratio, the more capable a company is of paying its short-term obligations. The cash ratio is calculated as follows~\cite{investopedia-cash-ratio}:
    \begin{equation}
        \begin{split}
            Cash\ Ratio&=\frac{Cash\&Equivalent}{Current\ Liabilities}\\
        \end{split}
    \end{equation}

    \paragraph{Inventory Turnover}\label{par:inventory-turnover}
    The inventory turnover ratio is a measure of how efficiently a company is managing its inventory. It is calculated by dividing a company's cost of goods sold by its average inventory. The higher the inventory turnover ratio, the more efficiently a company is managing its inventory. The inventory turnover ratio is calculated as follows~\cite{investopedia-inventory-turnover}:
    \begin{equation}
        \begin{split}
            Inventory\ Turnover&=\frac{Cost\ of\ Goods\ Sold}{Average\ Inventory}\\
        \end{split}
    \end{equation}

    \paragraph{Receivables Turnover}\label{par:receivables-turnover}
    The receivables turnover ratio is a measure of how efficiently a company is managing its accounts receivable. It is calculated by dividing a company's net credit sales by its average accounts receivable. The higher the receivables turnover ratio, the more efficiently a company is managing its accounts receivable. The receivables turnover ratio is calculated as follows~\cite{investopedia-recievables-turnover}:
    \begin{equation}
        \begin{split}
            Receivables\ Turnover&=\frac{Net\ Credit\ Sales}{Average\ Accounts\ Receivable}\\
        \end{split}
    \end{equation}

    \paragraph{Payables Turnover}\label{par:payables-turnover}
    The payables turnover ratio is a measure of how efficiently a company is managing its accounts payable. It is calculated by dividing a company's cost of goods sold by its average accounts payable. The higher the payables turnover ratio, the more efficiently a company is managing its accounts payable. The payables turnover ratio is calculated as follows~\cite{investopedia-payables-turnover}:
    \begin{equation}
        \begin{split}
            Payables\ Turnover&=\frac{TSP}{(BAP+EAP)/2}\\
        \end{split}
    \end{equation}
    where $TSP$ is the total supply purchase, $BAP$ is the beginning accounts payable, and $EAP$ is the ending accounts payable. If the payables turnover ratio is too low, it could be a sign that company has trouble paying its suppliers. If the payables turnover ratio is too high, it could be a sign that the company is not using its assets efficiently.

    \paragraph{Debt Ratio}\label{par:debt-ratio}
    The debt ratio is a measure of a company's financial leverage. It is calculated by dividing a company's total liabilities by its total assets. The higher the debt ratio, the more debt a company is using to finance its assets. The debt ratio is calculated as follows~\cite{investopedia-debt-ratio}:
    \begin{equation}
        \begin{split}
            Debt\ Ratio&=\frac{Traditional\ Debt+(Accounts\ Payable+Taxes\ Payable)}{Total Assets}\\
        \end{split}
    \end{equation}
    The lower the debt ratio, the better. A $Debt\ Ratio > 1.0$ means a company has more debt than assets while a $Debt\ Ratio < 1$ indicates that a company has more assets than debt.

    \paragraph{Debt Equity Ratio}\label{par:debt-equity-ratio}
    The debt equity ratio is a measure of a company's financial leverage. It is calculated by dividing a company's total liabilities by its total equity. The higher the debt equity ratio, the more debt a company is using to finance its assets. The debt equity ratio is calculated as follows~\cite{investopedia-debt-equity-ratio}:
    \begin{equation}
        \begin{split}
            Debt\ Equity\ Ratio&=\frac{Traditional\ Debt+(Accounts\ Payable+Taxes\ Payable)}{Total\ Equity}\\
        \end{split}
    \end{equation}

    \paragraph{Price Earnings Ratio}\label{par:price-earnings-ratio}
    The price earnings ratio is a measure of a company's value relative to its earnings. It is calculated by dividing a company's stock price by its earnings per share. The higher the price earnings ratio, the more expensive a company's stock is relative to its earnings. The price earnings ratio is calculated as follows~\cite{investopedia-price-earnings-ratio}:
    \begin{equation}
        \begin{split}
            Price\ Earnings\ Ratio&=\frac{Stock\ Price}{Earnings\ Per\ Share}\\
        \end{split}
    \end{equation}

    \paragraph{Price Book Value Ratio}\label{par:price-book-value-ratio}
    The price book value ratio is a measure of a company's value relative to its book value. It is calculated by dividing a company's stock price by its book value per share. The higher the price book value ratio, the more expensive a company's stock is relative to its book value. The price book value ratio is calculated as follows~\cite{investopedia-price-book-value-ratio}:
    \begin{equation}
        \begin{split}
            Price\ Book\ Value\ Ratio&=\frac{Stock\ Price}{Book\ Value\ Per\ Share}\\
        \end{split}
    \end{equation}

    \paragraph{Dividend Yield}\label{par:dividend-yield}
    The dividend yield is a measure of a company's profitability. It is calculated by dividing a company's annual dividend by its stock price. The higher the dividend yield, the more profitable a company is. The dividend yield is calculated as follows~\cite{investopedia-dividend-yield}:
    \begin{equation}
        \begin{split}
            Dividend\ Yield&=\frac{Annual\ Dividend}{Stock\ Price}\\
        \end{split}
    \end{equation}

    \subsubsection{Technical Analysis}\label{subsubsec:technical-analysis}
    Technical analysis is a method used in financial markets, such as stocks, currencies, and commodities, to analyze historical price data and identify patterns, trends, and signals that can be used to make trading decisions. Technical analysis is based on the belief that historical price and volume data can provide insights into future price movements, and it primarily focuses on analyzing price charts and other technical indicators.

    \subsubsection{Combined Fundamental and Technical Analysis}\label{subsubsec:combined-fundamental-and-technical-analysis}
    TODO

    \subsection{Dataset Splitting}\label{subsec:dataset-splitting}
    TODO


    \section{Implementation Details}\label{sec:implementation-details}
    TODO

    \subsection{Code Base}\label{subsec:code-base}
    TODO

    \subsubsection{Wandb}\label{subsubsec:wandb}
    TODO

    \subsection{Neural Networks}\label{subsec:neural-network}
    TODO

% TODO: Training Agent
% TODO: Testing Agent

\end{document}
